---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Image Classifier">
	<div class="hero">
		<div class="container">
			<h1 class="hero-title">Train Your Own<br/>Image Classifier</h1>
			<p class="hero-subtitle">Upload your dataset, train a model, and classify images with ease</p>
		</div>
	</div>

	<main class="main">
		<div class="container">
			<!-- Upload Dataset Section -->
			<section class="section" id="upload">
				<div class="section-header">
					<h2>Upload Dataset</h2>
					<p>Upload your training images organized in folders by class</p>
				</div>
				
				<div class="upload-area" id="uploadArea">
					<div class="upload-icon">
						<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
							<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
						</svg>
					</div>
					<h3>Drop your dataset folder here</h3>
					<p>or click to browse</p>
					<input type="file" id="datasetInput" webkitdirectory directory multiple hidden/>
					<button class="btn-secondary" id="browseBtn">Browse Files</button>
				</div>

				<div class="dataset-info" id="datasetInfo" style="display: none;">
					<div class="info-grid">
						<div class="info-card">
							<div class="info-label">Classes</div>
							<div class="info-value" id="classCount">0</div>
						</div>
						<div class="info-card">
							<div class="info-label">Total Images</div>
							<div class="info-value" id="imageCount">0</div>
						</div>
						<div class="info-card">
							<div class="info-label">Status</div>
							<div class="info-value" id="uploadStatus">Ready</div>
						</div>
					</div>
					<div class="class-list" id="classList"></div>
				</div>
			</section>

			<!-- Train Model Section -->
			<section class="section" id="train">
				<div class="section-header">
					<h2>Train Model</h2>
					<p>Configure training parameters and start training</p>
				</div>

				<div class="config-grid">
					<div class="form-group">
						<label for="epochs">Epochs</label>
						<input type="number" id="epochs" value="10" min="1" max="100"/>
					</div>
					<div class="form-group">
						<label for="batchSize">Batch Size</label>
						<input type="number" id="batchSize" value="32" min="8" max="128" step="8"/>
					</div>
					<div class="form-group">
						<label for="learningRate">Learning Rate</label>
						<input type="number" id="learningRate" value="0.001" min="0.0001" max="0.1" step="0.0001"/>
					</div>
				</div>

				<button class="btn-primary" id="trainBtn" disabled>
					<span>Start Training</span>
				</button>

				<div class="training-progress" id="trainingProgress" style="display: none;">
					<div class="progress-bar">
						<div class="progress-fill" id="progressFill"></div>
					</div>
					<div class="progress-stats">
						<span id="progressText">Training...</span>
						<span id="progressPercent">0%</span>
					</div>
				</div>
			</section>

			<!-- Test Model Section -->
			<section class="section" id="test">
				<div class="section-header">
					<h2>Test Your Model</h2>
					<p>Upload an image to classify</p>
				</div>

				<div class="test-area">
					<div class="image-upload" id="testUploadArea">
						<div class="upload-icon-small">
							<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
								<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
								<circle cx="8.5" cy="8.5" r="1.5"/>
								<polyline points="21 15 16 10 5 21"/>
							</svg>
						</div>
						<p>Click to upload test image</p>
						<input type="file" id="testImageInput" accept="image/*" hidden/>
					</div>

					<div class="prediction-result" id="predictionResult" style="display: none;">
						<img id="testImage" alt="Test image"/>
						<div class="result-info">
							<div class="predicted-class" id="predictedClass"></div>
							<div class="confidence-bar">
								<div class="confidence-fill" id="confidenceFill"></div>
							</div>
							<div class="confidence-text" id="confidenceText"></div>
						</div>
					</div>
				</div>
			</section>
		</div>
	</main>

	<footer class="footer">
		<div class="container">
			<p>Image Classifier Â© 2024</p>
		</div>
	</footer>
</Layout>

<style>
	:root {
		--color-bg: #ffffff;
		--color-surface: #f5f5f7;
		--color-text: #1d1d1f;
		--color-text-secondary: #86868b;
		--color-primary: #0071e3;
		--color-border: #d2d2d7;
		--color-success: #34c759;
		--radius: 12px;
		--shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
	}

	* {
		margin: 0;
		padding: 0;
		box-sizing: border-box;
	}

	.hero {
		background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		color: white;
		padding: 120px 0 80px;
		text-align: center;
	}

	.hero-title {
		font-size: 56px;
		font-weight: 700;
		letter-spacing: -0.02em;
		line-height: 1.1;
		margin-bottom: 20px;
	}

	.hero-subtitle {
		font-size: 21px;
		font-weight: 400;
		opacity: 0.9;
		max-width: 600px;
		margin: 0 auto;
	}

	.container {
		max-width: 980px;
		margin: 0 auto;
		padding: 0 22px;
	}

	.main {
		padding: 80px 0;
	}

	.section {
		margin-bottom: 100px;
	}

	.section-header {
		text-align: center;
		margin-bottom: 48px;
	}

	.section-header h2 {
		font-size: 40px;
		font-weight: 700;
		color: var(--color-text);
		margin-bottom: 12px;
	}

	.section-header p {
		font-size: 17px;
		color: var(--color-text-secondary);
	}

	.upload-area {
		background: var(--color-surface);
		border: 2px dashed var(--color-border);
		border-radius: var(--radius);
		padding: 60px 40px;
		text-align: center;
		cursor: pointer;
		transition: all 0.3s ease;
	}

	.upload-area:hover {
		border-color: var(--color-primary);
		background: #fafafa;
	}

	.upload-icon {
		color: var(--color-text-secondary);
		margin-bottom: 20px;
	}

	.upload-area h3 {
		font-size: 21px;
		font-weight: 600;
		color: var(--color-text);
		margin-bottom: 8px;
	}

	.upload-area p {
		color: var(--color-text-secondary);
		margin-bottom: 24px;
	}

	.btn-primary, .btn-secondary {
		font-size: 17px;
		font-weight: 500;
		padding: 14px 32px;
		border-radius: 980px;
		border: none;
		cursor: pointer;
		transition: all 0.3s ease;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		gap: 8px;
	}

	.btn-primary {
		background: var(--color-primary);
		color: white;
		width: 100%;
		max-width: 300px;
		margin: 32px auto;
		display: flex;
	}

	.btn-primary:hover:not(:disabled) {
		background: #0077ed;
		transform: translateY(-1px);
	}

	.btn-primary:disabled {
		opacity: 0.5;
		cursor: not-allowed;
	}

	.btn-secondary {
		background: white;
		color: var(--color-primary);
		border: 1px solid var(--color-border);
	}

	.btn-secondary:hover {
		background: var(--color-surface);
	}

	.dataset-info {
		margin-top: 40px;
	}

	.info-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: 20px;
		margin-bottom: 32px;
	}

	.info-card {
		background: white;
		padding: 24px;
		border-radius: var(--radius);
		box-shadow: var(--shadow);
		text-align: center;
	}

	.info-label {
		font-size: 13px;
		color: var(--color-text-secondary);
		text-transform: uppercase;
		letter-spacing: 0.5px;
		margin-bottom: 8px;
	}

	.info-value {
		font-size: 32px;
		font-weight: 700;
		color: var(--color-text);
	}

	.class-list {
		background: white;
		padding: 24px;
		border-radius: var(--radius);
		box-shadow: var(--shadow);
	}

	.config-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
		gap: 24px;
		margin-bottom: 32px;
	}

	.form-group {
		display: flex;
		flex-direction: column;
		gap: 8px;
	}

	.form-group label {
		font-size: 15px;
		font-weight: 500;
		color: var(--color-text);
	}

	.form-group input {
		font-size: 17px;
		padding: 12px 16px;
		border: 1px solid var(--color-border);
		border-radius: 8px;
		background: white;
		transition: all 0.2s ease;
	}

	.form-group input:focus {
		outline: none;
		border-color: var(--color-primary);
		box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1);
	}

	.training-progress {
		margin-top: 32px;
	}

	.progress-bar {
		height: 8px;
		background: var(--color-surface);
		border-radius: 4px;
		overflow: hidden;
		margin-bottom: 12px;
	}

	.progress-fill {
		height: 100%;
		background: linear-gradient(90deg, var(--color-primary), #00d4ff);
		transition: width 0.3s ease;
		width: 0%;
	}

	.progress-stats {
		display: flex;
		justify-content: space-between;
		font-size: 15px;
		color: var(--color-text-secondary);
	}

	.test-area {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 32px;
	}

	.image-upload {
		background: var(--color-surface);
		border: 2px dashed var(--color-border);
		border-radius: var(--radius);
		padding: 48px 24px;
		text-align: center;
		cursor: pointer;
		transition: all 0.3s ease;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		min-height: 300px;
	}

	.image-upload:hover {
		border-color: var(--color-primary);
		background: #fafafa;
	}

	.upload-icon-small {
		color: var(--color-text-secondary);
		margin-bottom: 16px;
	}

	.prediction-result {
		background: white;
		border-radius: var(--radius);
		box-shadow: var(--shadow);
		overflow: hidden;
	}

	.prediction-result img {
		width: 100%;
		height: 300px;
		object-fit: cover;
	}

	.result-info {
		padding: 24px;
	}

	.predicted-class {
		font-size: 28px;
		font-weight: 700;
		color: var(--color-text);
		margin-bottom: 16px;
	}

	.confidence-bar {
		height: 8px;
		background: var(--color-surface);
		border-radius: 4px;
		overflow: hidden;
		margin-bottom: 8px;
	}

	.confidence-fill {
		height: 100%;
		background: var(--color-success);
		transition: width 0.3s ease;
		width: 0%;
	}

	.confidence-text {
		font-size: 15px;
		color: var(--color-text-secondary);
	}

	.footer {
		background: var(--color-surface);
		padding: 32px 0;
		text-align: center;
		color: var(--color-text-secondary);
		font-size: 13px;
	}

	@media (max-width: 768px) {
		.hero-title {
			font-size: 40px;
		}

		.section-header h2 {
			font-size: 32px;
		}

		.test-area {
			grid-template-columns: 1fr;
		}

		.config-grid {
			grid-template-columns: 1fr;
		}
	}
</style>

<script>
	// Dataset upload handling
	const uploadArea = document.getElementById('uploadArea') as HTMLElement;
	const datasetInput = document.getElementById('datasetInput') as HTMLInputElement;
	const browseBtn = document.getElementById('browseBtn') as HTMLButtonElement;
	const datasetInfo = document.getElementById('datasetInfo') as HTMLElement;
	const trainBtn = document.getElementById('trainBtn') as HTMLButtonElement;

	let uploadedDataset: { [key: string]: File[] } = {};

	browseBtn?.addEventListener('click', () => datasetInput?.click());
	
	uploadArea?.addEventListener('click', () => datasetInput?.click());

	uploadArea?.addEventListener('dragover', (e) => {
		e.preventDefault();
		uploadArea.style.borderColor = 'var(--color-primary)';
	});

	uploadArea?.addEventListener('dragleave', () => {
		uploadArea.style.borderColor = 'var(--color-border)';
	});

	uploadArea?.addEventListener('drop', (e) => {
		e.preventDefault();
		uploadArea.style.borderColor = 'var(--color-border)';
		const files = Array.from(e.dataTransfer?.files || []);
		processDataset(files);
	});

	datasetInput?.addEventListener('change', (e) => {
		const files = Array.from((e.target as HTMLInputElement).files || []);
		processDataset(files);
	});

	function processDataset(files: File[]) {
		uploadedDataset = {};
		
		files.forEach(file => {
			if (file.type.startsWith('image/')) {
				const pathParts = file.webkitRelativePath.split('/');
				const className = pathParts[pathParts.length - 2];
				
				if (!uploadedDataset[className]) {
					uploadedDataset[className] = [];
				}
				uploadedDataset[className].push(file);
			}
		});

		const classCount = Object.keys(uploadedDataset).length;
		const imageCount = Object.values(uploadedDataset).reduce((sum, imgs) => sum + imgs.length, 0);

		if (classCount > 0) {
			document.getElementById('classCount')!.textContent = classCount.toString();
			document.getElementById('imageCount')!.textContent = imageCount.toString();
			document.getElementById('uploadStatus')!.textContent = 'Ready';
			
			const classList = document.getElementById('classList')!;
			classList.innerHTML = '<h4 style="margin-bottom: 16px; font-size: 17px;">Classes:</h4>' +
				Object.entries(uploadedDataset)
					.map(([name, imgs]) => `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-border);"><span>${name}</span><span style="color: var(--color-text-secondary);">${imgs.length} images</span></div>`)
					.join('');

			datasetInfo.style.display = 'block';
			trainBtn.disabled = false;
		}
	}

	// Training handling
	trainBtn?.addEventListener('click', async () => {
		const epochs = (document.getElementById('epochs') as HTMLInputElement).value;
		const batchSize = (document.getElementById('batchSize') as HTMLInputElement).value;
		const learningRate = (document.getElementById('learningRate') as HTMLInputElement).value;

		const trainingProgress = document.getElementById('trainingProgress')!;
		trainingProgress.style.display = 'block';

		// Simulate training progress
		let progress = 0;
		const interval = setInterval(() => {
			progress += Math.random() * 10;
			if (progress >= 100) {
				progress = 100;
				clearInterval(interval);
				document.getElementById('progressText')!.textContent = 'Training complete!';
			}
			document.getElementById('progressFill')!.style.width = progress + '%';
			document.getElementById('progressPercent')!.textContent = Math.round(progress) + '%';
		}, 500);
	});

	// Test image handling
	const testUploadArea = document.getElementById('testUploadArea') as HTMLElement;
	const testImageInput = document.getElementById('testImageInput') as HTMLInputElement;
	const predictionResult = document.getElementById('predictionResult') as HTMLElement;

	testUploadArea?.addEventListener('click', () => testImageInput?.click());

	testImageInput?.addEventListener('change', (e) => {
		const file = (e.target as HTMLInputElement).files?.[0];
		if (file) {
			const reader = new FileReader();
			reader.onload = (e) => {
				const img = document.getElementById('testImage') as HTMLImageElement;
				img.src = e.target?.result as string;
				
				// Simulate prediction
				const classes = Object.keys(uploadedDataset);
				if (classes.length > 0) {
					const randomClass = classes[Math.floor(Math.random() * classes.length)];
					const confidence = 75 + Math.random() * 20;
					
					document.getElementById('predictedClass')!.textContent = randomClass;
					document.getElementById('confidenceFill')!.style.width = confidence + '%';
					document.getElementById('confidenceText')!.textContent = `Confidence: ${confidence.toFixed(1)}%`;
					
					predictionResult.style.display = 'block';
				}
			};
			reader.readAsDataURL(file);
		}
	});
</script>
