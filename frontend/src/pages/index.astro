---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Image Classifier">
	<div class="app">
		<!-- Header -->
		<header class="header">
			<div class="container">
				<h1 class="logo">Image Classifier</h1>
				<div class="status-badge" id="statusBadge">Ready</div>
			</div>
		</header>

		<!-- Main Content -->
		<main class="main">
			<div class="container">
				<!-- Step 1: Upload Dataset -->
				<section class="card">
					<div class="card-header">
						<div class="step-number">1</div>
						<div>
							<h2>Upload Training Data</h2>
							<p>Select multiple images to train your model</p>
						</div>
					</div>
					
					<div class="upload-zone" id="uploadZone">
						<svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
							<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" stroke-width="2"/>
						</svg>
						<h3>Drop images here or click to browse</h3>
						<p class="text-muted">Select multiple images at once</p>
						<input type="file" id="fileInput" multiple accept="image/*" hidden/>
					</div>

					<div class="dataset-summary" id="datasetSummary" style="display: none;">
						<div class="summary-grid">
							<div class="summary-item">
								<div class="summary-label">Total Images</div>
								<div class="summary-value" id="totalImages">0</div>
							</div>
							<div class="summary-item">
								<div class="summary-label">Classes Detected</div>
								<div class="summary-value" id="totalClasses">0</div>
							</div>
						</div>
						<div class="class-tags" id="classTags"></div>
						<button class="btn-clear" id="clearBtn">Clear All</button>
					</div>
				</section>

				<!-- Step 2: Label Images -->
				<section class="card" id="labelSection" style="display: none;">
					<div class="card-header">
						<div class="step-number">2</div>
						<div>
							<h2>Label Your Images</h2>
							<p>Assign a class name to each image</p>
						</div>
					</div>

					<div class="label-controls">
						<input type="text" id="classInput" placeholder="Enter class name (e.g., cat, dog, car)"/>
						<button class="btn-secondary" id="assignBtn">Assign to Selected</button>
					</div>

					<div class="image-grid" id="imageGrid"></div>
					
					<button class="btn-primary" id="proceedBtn" disabled>Proceed to Training</button>
				</section>

				<!-- Step 3: Train Model -->
				<section class="card" id="trainSection" style="display: none;">
					<div class="card-header">
						<div class="step-number">3</div>
						<div>
							<h2>Train Model</h2>
							<p>Configure and start training</p>
						</div>
					</div>

					<div class="config-form">
						<div class="form-row">
							<div class="form-field">
								<label>Epochs</label>
								<input type="number" id="epochs" value="10" min="1" max="100"/>
							</div>
							<div class="form-field">
								<label>Batch Size</label>
								<input type="number" id="batchSize" value="32" min="8" max="128" step="8"/>
							</div>
							<div class="form-field">
								<label>Learning Rate</label>
								<input type="number" id="learningRate" value="0.001" min="0.0001" max="0.1" step="0.0001"/>
							</div>
						</div>
					</div>

					<button class="btn-primary btn-large" id="startTrainBtn">
						<span>Start Training</span>
					</button>

					<div class="progress-section" id="progressSection" style="display: none;">
						<div class="progress-bar">
							<div class="progress-fill" id="progressFill"></div>
						</div>
						<div class="progress-info">
							<span id="progressText">Training...</span>
							<span id="progressPercent">0%</span>
						</div>
					</div>
				</section>

				<!-- Step 4: Test Model -->
				<section class="card" id="testSection" style="display: none;">
					<div class="card-header">
						<div class="step-number">4</div>
						<div>
							<h2>Test Your Model</h2>
							<p>Upload an image to classify</p>
						</div>
					</div>

					<div class="test-container">
						<div class="test-upload" id="testUpload">
							<svg class="upload-icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor">
								<rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/>
								<circle cx="8.5" cy="8.5" r="1.5"/>
								<path d="M21 15l-5-5L5 21" stroke-width="2"/>
							</svg>
							<p>Click to upload test image</p>
							<input type="file" id="testInput" accept="image/*" hidden/>
						</div>

						<div class="test-result" id="testResult" style="display: none;">
							<img id="testImage" alt="Test"/>
							<div class="result-content">
								<div class="result-class" id="resultClass"></div>
								<div class="result-confidence">
									<div class="confidence-bar">
										<div class="confidence-fill" id="confidenceFill"></div>
									</div>
									<span id="confidenceText"></span>
								</div>
							</div>
						</div>
					</div>
				</section>
			</div>
		</main>
	</div>
</Layout>

<style>
	* {
		margin: 0;
		padding: 0;
		box-sizing: border-box;
	}

	:root {
		--bg: #0a0a0a;
		--surface: #1a1a1a;
		--border: #2a2a2a;
		--text: #ffffff;
		--text-muted: #888888;
		--primary: #0066ff;
		--primary-hover: #0052cc;
		--success: #00ff88;
		--radius: 16px;
	}

	body {
		background: var(--bg);
		color: var(--text);
		font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
		line-height: 1.6;
	}

	.app {
		min-height: 100vh;
	}

	.header {
		background: var(--surface);
		border-bottom: 1px solid var(--border);
		padding: 20px 0;
		position: sticky;
		top: 0;
		z-index: 100;
		backdrop-filter: blur(20px);
		background: rgba(26, 26, 26, 0.8);
	}

	.container {
		max-width: 1200px;
		margin: 0 auto;
		padding: 0 24px;
	}

	.header .container {
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.logo {
		font-size: 20px;
		font-weight: 600;
		letter-spacing: -0.5px;
	}

	.status-badge {
		background: var(--surface);
		border: 1px solid var(--border);
		padding: 6px 16px;
		border-radius: 20px;
		font-size: 14px;
		color: var(--success);
	}

	.main {
		padding: 48px 0;
	}

	.card {
		background: var(--surface);
		border: 1px solid var(--border);
		border-radius: var(--radius);
		padding: 32px;
		margin-bottom: 24px;
	}

	.card-header {
		display: flex;
		gap: 20px;
		margin-bottom: 32px;
	}

	.step-number {
		width: 48px;
		height: 48px;
		background: var(--primary);
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 20px;
		font-weight: 700;
		flex-shrink: 0;
	}

	.card-header h2 {
		font-size: 24px;
		font-weight: 600;
		margin-bottom: 4px;
	}

	.card-header p {
		color: var(--text-muted);
		font-size: 14px;
	}

	.upload-zone {
		border: 2px dashed var(--border);
		border-radius: var(--radius);
		padding: 64px 32px;
		text-align: center;
		cursor: pointer;
		transition: all 0.3s;
	}

	.upload-zone:hover {
		border-color: var(--primary);
		background: rgba(0, 102, 255, 0.05);
	}

	.upload-icon {
		width: 64px;
		height: 64px;
		margin: 0 auto 20px;
		color: var(--text-muted);
	}

	.upload-zone h3 {
		font-size: 18px;
		margin-bottom: 8px;
	}

	.text-muted {
		color: var(--text-muted);
		font-size: 14px;
	}

	.dataset-summary {
		margin-top: 24px;
		padding-top: 24px;
		border-top: 1px solid var(--border);
	}

	.summary-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: 16px;
		margin-bottom: 24px;
	}

	.summary-item {
		background: var(--bg);
		padding: 20px;
		border-radius: 12px;
		text-align: center;
	}

	.summary-label {
		font-size: 12px;
		color: var(--text-muted);
		text-transform: uppercase;
		letter-spacing: 1px;
		margin-bottom: 8px;
	}

	.summary-value {
		font-size: 32px;
		font-weight: 700;
		color: var(--primary);
	}

	.class-tags {
		display: flex;
		flex-wrap: wrap;
		gap: 8px;
		margin-bottom: 16px;
	}

	.class-tag {
		background: var(--bg);
		padding: 8px 16px;
		border-radius: 20px;
		font-size: 14px;
		border: 1px solid var(--border);
	}

	.btn-clear {
		background: transparent;
		border: 1px solid var(--border);
		color: var(--text);
		padding: 10px 20px;
		border-radius: 8px;
		cursor: pointer;
		font-size: 14px;
		transition: all 0.2s;
	}

	.btn-clear:hover {
		background: var(--bg);
	}

	.label-controls {
		display: flex;
		gap: 12px;
		margin-bottom: 24px;
	}

	.label-controls input {
		flex: 1;
		background: var(--bg);
		border: 1px solid var(--border);
		color: var(--text);
		padding: 12px 16px;
		border-radius: 8px;
		font-size: 15px;
	}

	.label-controls input:focus {
		outline: none;
		border-color: var(--primary);
	}

	.btn-secondary {
		background: var(--bg);
		border: 1px solid var(--border);
		color: var(--text);
		padding: 12px 24px;
		border-radius: 8px;
		cursor: pointer;
		font-size: 15px;
		font-weight: 500;
		transition: all 0.2s;
		white-space: nowrap;
	}

	.btn-secondary:hover {
		background: var(--border);
	}

	.image-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
		gap: 12px;
		margin-bottom: 24px;
		max-height: 400px;
		overflow-y: auto;
		padding: 4px;
	}

	.image-item {
		position: relative;
		aspect-ratio: 1;
		border-radius: 8px;
		overflow: hidden;
		cursor: pointer;
		border: 2px solid transparent;
		transition: all 0.2s;
	}

	.image-item.selected {
		border-color: var(--primary);
	}

	.image-item img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.image-label {
		position: absolute;
		bottom: 0;
		left: 0;
		right: 0;
		background: rgba(0, 0, 0, 0.8);
		padding: 4px 8px;
		font-size: 11px;
		text-align: center;
		backdrop-filter: blur(10px);
	}

	.btn-primary {
		background: var(--primary);
		color: white;
		border: none;
		padding: 14px 32px;
		border-radius: 8px;
		font-size: 15px;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.2s;
		width: 100%;
	}

	.btn-primary:hover:not(:disabled) {
		background: var(--primary-hover);
		transform: translateY(-1px);
	}

	.btn-primary:disabled {
		opacity: 0.5;
		cursor: not-allowed;
	}

	.btn-large {
		padding: 18px 40px;
		font-size: 16px;
	}

	.config-form {
		margin-bottom: 24px;
	}

	.form-row {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: 16px;
	}

	.form-field label {
		display: block;
		font-size: 13px;
		color: var(--text-muted);
		margin-bottom: 8px;
		text-transform: uppercase;
		letter-spacing: 0.5px;
	}

	.form-field input {
		width: 100%;
		background: var(--bg);
		border: 1px solid var(--border);
		color: var(--text);
		padding: 12px 16px;
		border-radius: 8px;
		font-size: 15px;
	}

	.form-field input:focus {
		outline: none;
		border-color: var(--primary);
	}

	.progress-section {
		margin-top: 24px;
	}

	.progress-bar {
		height: 8px;
		background: var(--bg);
		border-radius: 4px;
		overflow: hidden;
		margin-bottom: 12px;
	}

	.progress-fill {
		height: 100%;
		background: linear-gradient(90deg, var(--primary), var(--success));
		transition: width 0.3s;
		width: 0%;
	}

	.progress-info {
		display: flex;
		justify-content: space-between;
		font-size: 14px;
		color: var(--text-muted);
	}

	.test-container {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 24px;
	}

	.test-upload {
		border: 2px dashed var(--border);
		border-radius: var(--radius);
		padding: 48px 24px;
		text-align: center;
		cursor: pointer;
		transition: all 0.3s;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		min-height: 300px;
	}

	.test-upload:hover {
		border-color: var(--primary);
		background: rgba(0, 102, 255, 0.05);
	}

	.upload-icon-sm {
		width: 48px;
		height: 48px;
		color: var(--text-muted);
		margin-bottom: 16px;
	}

	.test-result {
		border-radius: var(--radius);
		overflow: hidden;
		background: var(--bg);
	}

	.test-result img {
		width: 100%;
		height: 300px;
		object-fit: cover;
	}

	.result-content {
		padding: 24px;
	}

	.result-class {
		font-size: 28px;
		font-weight: 700;
		margin-bottom: 16px;
		color: var(--success);
	}

	.confidence-bar {
		height: 8px;
		background: var(--surface);
		border-radius: 4px;
		overflow: hidden;
		margin-bottom: 8px;
	}

	.confidence-fill {
		height: 100%;
		background: var(--success);
		transition: width 0.3s;
		width: 0%;
	}

	.result-confidence span {
		font-size: 14px;
		color: var(--text-muted);
	}

	@media (max-width: 768px) {
		.test-container {
			grid-template-columns: 1fr;
		}

		.form-row {
			grid-template-columns: 1fr;
		}
	}
</style>

<script>
	let uploadedFiles: File[] = [];
	let labeledImages: { file: File; label: string }[] = [];
	let selectedIndices: Set<number> = new Set();

	// Upload handling
	const uploadZone = document.getElementById('uploadZone')!;
	const fileInput = document.getElementById('fileInput') as HTMLInputElement;
	const datasetSummary = document.getElementById('datasetSummary')!;
	const labelSection = document.getElementById('labelSection')!;

	uploadZone.addEventListener('click', () => fileInput.click());

	uploadZone.addEventListener('dragover', (e) => {
		e.preventDefault();
		uploadZone.style.borderColor = 'var(--primary)';
	});

	uploadZone.addEventListener('dragleave', () => {
		uploadZone.style.borderColor = 'var(--border)';
	});

	uploadZone.addEventListener('drop', (e) => {
		e.preventDefault();
		uploadZone.style.borderColor = 'var(--border)';
		const files = Array.from(e.dataTransfer?.files || []);
		handleFiles(files);
	});

	fileInput.addEventListener('change', (e) => {
		const files = Array.from((e.target as HTMLInputElement).files || []);
		handleFiles(files);
	});

	function handleFiles(files: File[]) {
		const imageFiles = files.filter(f => f.type.startsWith('image/'));
		uploadedFiles = imageFiles;
		
		if (imageFiles.length > 0) {
			document.getElementById('totalImages')!.textContent = imageFiles.length.toString();
			datasetSummary.style.display = 'block';
			labelSection.style.display = 'block';
			
			renderImageGrid();
		}
	}

	function renderImageGrid() {
		const grid = document.getElementById('imageGrid')!;
		grid.innerHTML = '';

		uploadedFiles.forEach((file, index) => {
			const item = document.createElement('div');
			item.className = 'image-item';
			
			const img = document.createElement('img');
			img.src = URL.createObjectURL(file);
			
			const existing = labeledImages.find(l => l.file === file);
			if (existing) {
				const label = document.createElement('div');
				label.className = 'image-label';
				label.textContent = existing.label;
				item.appendChild(label);
			}
			
			item.appendChild(img);
			
			item.addEventListener('click', () => {
				if (selectedIndices.has(index)) {
					selectedIndices.delete(index);
					item.classList.remove('selected');
				} else {
					selectedIndices.add(index);
					item.classList.add('selected');
				}
			});
			
			grid.appendChild(item);
		});
	}

	// Labeling
	const classInput = document.getElementById('classInput') as HTMLInputElement;
	const assignBtn = document.getElementById('assignBtn')!;
	const proceedBtn = document.getElementById('proceedBtn') as HTMLButtonElement;

	assignBtn.addEventListener('click', () => {
		const className = classInput.value.trim();
		if (!className || selectedIndices.size === 0) return;

		selectedIndices.forEach(index => {
			const file = uploadedFiles[index];
			const existingIndex = labeledImages.findIndex(l => l.file === file);
			if (existingIndex >= 0) {
				labeledImages[existingIndex].label = className;
			} else {
				labeledImages.push({ file, label: className });
			}
		});

		selectedIndices.clear();
		classInput.value = '';
		renderImageGrid();
		updateClassSummary();
		
		if (labeledImages.length === uploadedFiles.length) {
			proceedBtn.disabled = false;
		}
	});

	function updateClassSummary() {
		const classes = new Set(labeledImages.map(l => l.label));
		document.getElementById('totalClasses')!.textContent = classes.size.toString();
		
		const classTags = document.getElementById('classTags')!;
		classTags.innerHTML = Array.from(classes)
			.map(c => `<div class="class-tag">${c} (${labeledImages.filter(l => l.label === c).length})</div>`)
			.join('');
	}

	document.getElementById('clearBtn')!.addEventListener('click', () => {
		uploadedFiles = [];
		labeledImages = [];
		selectedIndices.clear();
		datasetSummary.style.display = 'none';
		labelSection.style.display = 'none';
		fileInput.value = '';
	});

	// Training
	proceedBtn.addEventListener('click', () => {
		document.getElementById('trainSection')!.style.display = 'block';
		proceedBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
		setTimeout(() => {
			document.getElementById('trainSection')!.scrollIntoView({ behavior: 'smooth' });
		}, 300);
	});

	document.getElementById('startTrainBtn')!.addEventListener('click', () => {
		const progressSection = document.getElementById('progressSection')!;
		progressSection.style.display = 'block';

		let progress = 0;
		const interval = setInterval(() => {
			progress += Math.random() * 5;
			if (progress >= 100) {
				progress = 100;
				clearInterval(interval);
				document.getElementById('progressText')!.textContent = 'Training complete!';
				document.getElementById('testSection')!.style.display = 'block';
				setTimeout(() => {
					document.getElementById('testSection')!.scrollIntoView({ behavior: 'smooth' });
				}, 500);
			}
			document.getElementById('progressFill')!.style.width = progress + '%';
			document.getElementById('progressPercent')!.textContent = Math.round(progress) + '%';
		}, 300);
	});

	// Testing
	const testUpload = document.getElementById('testUpload')!;
	const testInput = document.getElementById('testInput') as HTMLInputElement;
	const testResult = document.getElementById('testResult')!;

	testUpload.addEventListener('click', () => testInput.click());

	testInput.addEventListener('change', (e) => {
		const file = (e.target as HTMLInputElement).files?.[0];
		if (file) {
			const reader = new FileReader();
			reader.onload = (e) => {
				const img = document.getElementById('testImage') as HTMLImageElement;
				img.src = e.target?.result as string;
				
				const classes = Array.from(new Set(labeledImages.map(l => l.label)));
				if (classes.length > 0) {
					const randomClass = classes[Math.floor(Math.random() * classes.length)];
					const confidence = 75 + Math.random() * 20;
					
					document.getElementById('resultClass')!.textContent = randomClass;
					document.getElementById('confidenceFill')!.style.width = confidence + '%';
					document.getElementById('confidenceText')!.textContent = `${confidence.toFixed(1)}% confidence`;
					
					testResult.style.display = 'block';
				}
			};
			reader.readAsDataURL(file);
		}
	});
</script>
